<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSH Silent Auction</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #ecefd0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo img {
            max-width: 300px;
            height: auto;
        }

        header {
            text-align: center;
            color: #697D83;
            padding: 20px 20px 40px;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-weight: 700;
            color: #6E8348;
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.95;
            color: #697D83;
        }

        .phone-explanation {
            text-align: center;
            color: #ef5a87;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.75rem;
            font-style: italic;
        }

        .auction-status {
            background: rgba(229, 159, 43, 0.2);
            color: #E59F2B;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: 600;
        }

        .auction-status.closed {
            background: rgba(255,67,54,0.8);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            padding: 20px;
        }

        .item-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .item-card.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .item-card.disabled:hover {
            transform: none;
        }

        .item-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .item-content {
            padding: 20px;
        }

        .item-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .item-price {
            font-size: 1.5rem;
            color: #6E8348;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
            gap: 8px;
            transition: transform 0.2s ease;
        }

        .price-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }

        .bid-increment {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 15px;
        }

        .quantity-indicator {
            font-size: 0.85rem;
            color: #6E8348;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-indicator::before {
            content: "üì¶";
            font-size: 1rem;
        }

        .bidder-identifier {
            font-size: 0.85rem;
            color: #1a2a4e;
            background: #e6f9ff;
            padding: 6px 12px;
            border-radius: 6px;
            display: block;
            margin-top: 10px;
            font-weight: 600;
            text-align: center;
            border: 1px solid #00d9ff;
        }

        .top-bidders-container {
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .top-bidders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #e9ecef;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            transition: background 0.2s ease;
        }

        .top-bidders-header:hover {
            background: #dee2e6;
        }

        .top-bidders-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #495057;
        }

        .quantity-badge {
            background: #6E8348;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }

        .top-bidders-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .top-bidders-list.expanded {
            max-height: 500px;
        }

        .bidder-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }

        .bidder-row:hover {
            background: #f8f9fa;
        }

        .bidder-rank {
            font-weight: 700;
            color: #6E8348;
            min-width: 30px;
        }

        .bidder-amount {
            font-weight: 600;
            color: #212529;
        }

        .bidder-phone {
            color: #6c757d;
            font-family: monospace;
        }

        .no-bids-message {
            padding: 12px;
            text-align: center;
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
        }

        .item-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn-details {
            background: #f0f0f0;
            color: #333;
        }

        .btn-details:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .btn-bid {
            background: linear-gradient(135deg, #6E8348 0%, #5a6b3a 100%);
            color: white;
            font-weight: 600;
        }

        .btn-bid:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(110, 131, 72, 0.4);
        }

        .btn-bid:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
            padding-right: 40px;
        }

        .modal-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #666;
            margin-bottom: 20px;
        }

        .modal-price {
            font-size: 1.8rem;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input.error {
            border-color: #ff4444;
        }

        /* Hidden honeypot field for bot protection */
        .website-field {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .submit-btn, .confirm-btn, .edit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #E59F2B 0%, #d18a1f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .submit-btn:hover, .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 159, 43, 0.4);
        }

        .submit-btn:disabled, .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .edit-btn {
            background: #6c757d;
        }

        .edit-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .error-banner {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .confirmation-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .confirmation-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .confirmation-item:last-child {
            border-bottom: none;
        }

        .confirmation-label {
            font-weight: 600;
            color: #495057;
        }

        .confirmation-value {
            color: #212529;
        }

        .bid-amount-pill {
            background: #E59F2B;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .loading-indicator {
            text-align: center;
            color: rgb(0, 0, 0);
            padding: 20px;
            font-size: 1.1rem;
        }

        .rate-limit-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9rem;
        }

        /* Visual pulse when price changes */
        .price-updated {
            animation: pricePulse 700ms ease;
        }

        @keyframes pricePulse {
            0% { transform: scale(1); color: #6E8348; }
            30% { transform: scale(1.06); color: #5a6b3a; }
            100% { transform: scale(1); color: #6E8348; }
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
            color: #697D83;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }

        footer a {
            color: #6E8348;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="lsh-logo.png" alt="LSH PT Logo" onerror="this.style.display='none'">
        </div>
        <header>
            <h1>LSH Silent Auction 2025</h1>
            <p>Bid on amazing items and support a great cause!</p>
            <div class="auction-status" id="auctionStatus">Auction is OPEN</div>
            <p class="phone-explanation">The last 4 digits of the highest bidder's phone number are shown with each item.</p>
        </header>

        <div class="loading-indicator" id="loadingIndicator" style="display: none;">Loading current bids...</div>

        <div style="max-width: 900px; margin: 0 auto 50px; padding: 20px; background: #fff3cd; border-left: 4px solid #E59F2B; border-radius: 8px;">
            <p style="color: #856404; line-height: 1.6; margin: 0; font-size: 0.95rem;">
                <strong>Important:</strong> All funds raised goes toward the Lucy S. Herring Elementary Parent Team initiatives including teacher appreciation, teacher mini-grants, class field trips, and other school needs. Highest bidders will be notified at close of auction on December 7, 2025 and will be sent official communication from the Lucy S. Herring Parent Team on how to remit payment for their item(s) online. Payment must be made before the item is available to be received. If it's a physical item, the winner must be in or come to the Asheville-area to retrieve the item, all to be coordinated after payment is received. Thanks and please reach out to Mindy Smith at <a href="mailto:herringparentteam@gmail.com" style="color: #856404; text-decoration: underline;">herringparentteam@gmail.com</a> with any questions.
            </p>
        </div>

        <div class="items-grid" id="itemsGrid"></div>

        <footer>
            <p>Site created by Scott McFall with the help of AI. Contact: <a href="mailto:scott@scottmcfall.com">scott@scottmcfall.com</a> for inquiries.</p>
        </footer>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeDetailsModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <p class="modal-description" id="modalDescription"></p>
            <div class="modal-price">
                <span class="price-label">Current Bid: </span>
                <span id="modalPrice"></span>
            </div>
        </div>
    </div>

    <!-- Bid Form Modal -->
    <div id="bidModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeBidModal()">&times;</button>
            <h2 class="modal-title">Place Your Bid</h2>
            <p class="modal-description" id="bidItemName"></p>
            <div class="modal-price">
                <span class="price-label">Current Bid: </span>
                <span id="bidCurrentPrice"></span>
            </div>
            
            <div class="success-message" id="successMessage">
                üéâ Your bid has been submitted successfully! You will receive a confirmation email shortly.
            </div>

            <div class="error-banner" id="errorBanner"></div>

            <div class="rate-limit-warning" id="rateLimitWarning">
                ‚ö†Ô∏è You've submitted multiple bids recently. Please wait a moment before bidding again.
            </div>

            <form id="bidForm">
                <div class="form-group">
                    <label for="fullName">Full Name *</label>
                    <input type="text" id="fullName" name="fullName" maxlength="50" required>
                    <span class="error-message" id="nameError">Please enter your name</span>
                </div>

                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" maxlength="100" required>
                    <span class="error-message" id="emailError">Please enter a valid email</span>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" name="phone" placeholder="555-123-4567" required>
                    <span class="error-message" id="phoneError">Please enter a valid phone number</span>
                </div>

                <div class="form-group">
                    <label for="bidAmount">Bid Amount ($) *</label>
                    <input type="number" id="bidAmount" name="bidAmount" min="1" step="1" required>
                    <span class="error-message" id="bidError">Please enter a valid bid amount</span>
                </div>

                <!-- Honeypot field for bot protection -->
                <input type="text" name="website" class="website-field" tabindex="-1" autocomplete="off">

                <button type="submit" class="submit-btn" id="submitBtn">Review Bid</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
            <h2 class="modal-title">‚ö†Ô∏è Confirm Your Bid</h2>
            <p class="modal-description">Please review your bid details carefully before confirming:</p>
            
            <div class="confirmation-section">
                <div class="confirmation-item">
                    <span class="confirmation-label">Item:</span>
                    <span class="confirmation-value" id="confirmItemName"></span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Your Email:</span>
                    <span class="confirmation-value" id="confirmEmail"></span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Your Bid:</span>
                    <span class="bid-amount-pill" id="confirmBidAmount"></span>
                </div>
            </div>

            <p style="color: #6c757d; font-size: 0.95rem; margin: 20px 0;">
                ‚úâÔ∏è A confirmation email will be sent to the address shown above. 
                Please verify it's correct before confirming.
            </p>

            <button class="confirm-btn" id="confirmBtn" onclick="confirmAndSubmitBid()">Confirm Bid</button>
            <button class="edit-btn" onclick="editBid()">‚Üê Edit Bid</button>
        </div>
    </div>

    <script>
        // CONFIGURATION: Replace with your actual Google Apps Script Web App URL
        // IMPORTANT: Use the /exec URL, NOT the googleusercontent.com URL!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywQJkfZjWudhqoNatVWvAFWOwz8ZvDH-LzWZM1bpt4zUWIomgJg9lFcLeCa2OV3imq-w/exec';
        
        // Auction configuration
        const AUCTION_END_TIME = new Date('2025-12-08T23:59:59'); // Set your auction end time
        
        // Item data - Update this with your actual items
        // Optional 'quantity' field for multi-winner items (defaults to 1)
        const items = [
            {
                id: 'item0',
                name: 'AI Consultation',
                description: '1 hour consultation to see how AI can help you and your business GROW! Email scott@scottmcfall.com to schedule.',
                startingBid: 30,
                imageUrl: 'Images/scott1.jpg',
            },
            {
                id: 'item1',
                name: '1 Hour Dietitian Consultation',
                description: '1 hour consultation with a Registered Dietitian Nutritionist.',
                startingBid: 60,
                imageUrl: 'Images/1 hour consultation with a Registered Dietitian Nutritionist .jpeg',
            },
            {
                id: 'item2',
                name: 'Orange Peel Concert Package',
                description: 'Gift Certificate good for 2 Tickets to any show at The Orange Peel* and merch bundle. The Orange Peel.',
                startingBid: 40,
                imageUrl: 'Images/Orange Peel.jpg',
            },
            {
                id: 'item3',
                name: 'rEvolve Gift Card - $100 value',
                description: '1 $100 gift card to rEvolve buy‚Ä¢sell‚Ä¢trade // instagram @revolve_merc',
                startingBid: 10,
                imageUrl: 'https://images.unsplash.com/photo-1513885535751-8b9238bd345a?w=400',
                quantity: 2
            },
            {
                id: 'item4',
                name: 'Kids Yoga & Art Session',
                description: '1 - 1:1 Session with Asheville Kids Yoga & Art. http://www.ashevillekidsyogaandart.com',
                startingBid: 20,
                imageUrl: 'Images/1 - 1-1 Session with Asheville Kids Yoga & Art .jpg',
            },
            {
                id: 'item5',
                name: 'Homemade Cookies - 3 Months',
                description: 'A monthly batch of homemade cookies! One batch (about twenty cookies) of your favorite cookie from "100 Cookies" by Sarah Kieffer once a month for three months from January through March.',
                startingBid: 60,
                imageUrl: 'Images/Homemade cookies.jpg',
            },
            {
                id: 'item6',
                name: 'Sommelier Wine Tasting',
                description: 'Sommelier led wine tasting & class for up to 6 people - theme of your choosing, wine provided. Led by Cara Fuseler, Certified Sommelier.',
                startingBid: 300,
                imageUrl: 'Images/Sommelier led wine tasting & class for up to 6 people - theme of your choosing, wine provided.JPEG',
            },
            {
                id: 'item7',
                name: 'Wagner Family Wines',
                description: '2 bottles of wine from the Wagner Family: Caymus California Cabernet & Mer Soleil Chardonnay.',
                startingBid: 45,
                imageUrl: 'https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=400&q=80',
            },
            {
                id: 'item8',
                name: 'Jeeper Champagne',
                description: '2 bottles of Champagne Jeeper: Blanc de Blancs & Premier Cru Brut.',
                startingBid: 75,
                imageUrl: 'https://images.unsplash.com/photo-1547595628-c61a29f496f0?w=400&q=80',
            },
            {
                id: 'item9',
                name: 'French Wine Collection',
                description: '3 bottles of French wine (red, white, and ros√©): Provence Ros√©, Sancerre Blanc, and Bordeaux.',
                startingBid: 45,
                imageUrl: 'https://images.unsplash.com/photo-1506377247377-2a5b3b417ebb?w=400&q=80',
            },
            {
                id: 'item10',
                name: 'Italian Wine Duo',
                description: '2 Italian wines: Pinot Grigio and a red blend from Piedmont.',
                startingBid: 20,
                imageUrl: 'Images/2 wines.png',
            },
            {
                id: 'item11',
                name: 'California Chardonnay Collection',
                description: 'Explore Chardonnay with 3 bottles from California.',
                startingBid: 25,
                imageUrl: 'Images/Calironia Chardonnay Collection.jpg',
            },
            {
                id: 'item12',
                name: 'Private Tutoring Sessions',
                description: '2 hours of private tutoring, all ages, most subjects covered. Blue Ridge Tutoring www.blueridgetutoring.com',
                startingBid: 40,
                imageUrl: 'Images/2 hours of private tutoring, all ages, most subjects covered.jpeg',
            },
            {
                id: 'item13',
                name: '187 Killer Pads Set',
                description: '187 Six-Pack Pad Set - Adult sized Wrist, Knee, Elbow Pads. 187 Killer Pads.',
                startingBid: 10,
                imageUrl: 'Images/187 Knee Pads.png',
            },
            {
                id: 'item14',
                name: 'Fresh Cinnamon Rolls',
                description: '12 Cinnamon Rolls from scratch with Cream Cheese Icing (baked, or unbaked with instructions).',
                startingBid: 10,
                imageUrl: 'Images/12 Cinnamon Rolls from scratch with Cream Cheese Icing (baked, or unbaked with instructions).jpeg',
            },
            {
                id: 'item15',
                name: 'Kendra Scott Necklace',
                description: 'Kendra Scott Gold Sun Pendant Necklace.',
                startingBid: 40,
                imageUrl: 'Images/Kendra_Scott_Gold_Sun_Pendant_Necklace_.jpg',
            },
            {
                id: 'item16',
                name: 'Handmade Large Bag',
                description: 'Hand made large bag (15in. Across, 14in. Wide and 13 in. Long/deep.) by Daniele O Designs, danieleodesigns.com',
                startingBid: 90,
                imageUrl: 'Images/Hand made large bag.jpg',
            },
            {
                id: 'item17',
                name: 'Cameras Note Cards',
                description: '"Cameras" Set of four blank note cards & envelopes. Digital design, inkjet print, hand-painted watercolor, (4.5" x 6"). Rhododendron Press',
                startingBid: 10,
                imageUrl: 'Images/cameras-cards.jpg',
            },
            {
                id: 'item18',
                name: 'Skates Note Cards',
                description: '"Skates" Set of four blank note cards & envelopes. Digital design, inkjet print, hand-painted watercolor, paint pen, (4.5" x 6"). Rhododendron Press',
                startingBid: 10,
                imageUrl: 'Images/skates-cards.jpg',
            },
            {
                id: 'item19',
                name: 'Lace Note Cards',
                description: '"Lace" Set of four blank note cards & envelopes. Cyanotype prints with lace, (4.5" x 6"). Rhododendron Press',
                startingBid: 10,
                imageUrl: 'Images/lace-cards.jpg',
            },
            {
                id: 'item20',
                name: 'Jalapeno Jelly Jar',
                description: '8oz jar of homemade jalapeno jelly. Perfect for pairing with cheese or as a unique gift!',
                startingBid: 5,
                imageUrl: 'Images/jalapeno-jelly.jpg',
                quantity: 12,
            },
            {
                id: 'item21',
                name: 'Blue Beaded Earrings',
                description: 'A pair of handmade drop earrings featuring a small gold stud with a dangling bead arrangement, including a dark bead, gold spacers, and a larger marbled gray-blue bead at the bottom; simple, subtle, and sophisticated. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-blue-earrings.jpg',
            },
            {
                id: 'item22',
                name: 'Purple Dangle Earrings',
                description: 'A pair of handmade dangle earrings featuring a gold hook and a vertical stack of irregular, translucent gemstone chips in pastel shades of purple, green, and clear, separated by shiny gold spacer beads, a delicate, colorful, and elegant set with a natural, boho touch. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/purple_dangle_earrings.jpg',
            },
            {
                id: 'item23',
                name: 'LSH-Themed Bracelet',
                description: 'Beaded bracelet features glossy turquoise beads paired with gold accents. Three colorful circular charms hang from the front‚Äîyellow with an L, light blue with an S, and red with an H‚Äîrepresenting Lucy S. Herring Elementary School of Ecology, bright, playful, and school-spirited. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-lsh-bracelet.jpg',
            },
            {
                id: 'item24',
                name: 'Blue-Black Metallic Bracelet',
                description: 'The bracelet features dark blue evil-eye beads, silver spacer beads, and a silver Hamsa hand charm. This bracelet is a symbol of a protective, symbolic, and handcrafted look. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-blue-black-bracelet.jpg',
            },
            {
                id: 'item25',
                name: 'Packaged Turquoise Bracelet',
                description: 'A soft aqua beads bracelet mixed with multicolored accent beads in shades of white, blue, peach, and purple, along with small metallic spacers that are bright, delicate, and artisan-crafted. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-turquoise-packaged.jpg',
            },
            {
                id: 'item26',
                name: 'Big Brown Stone Bracelet',
                description: 'Large polished brown stone is the centerpiece. The bracelet is accented with rounded tiger\'s-eye beads and antique gold-toned spacers, earthy, bold, and elegant. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-brown-stone.jpg',
            },
            {
                id: 'item27',
                name: 'Turquoise Bracelet with Feather',
                description: 'A turquoise-toned beaded bracelet that features frosted teal beads, silver accents, and small dangling charms, including a leaf and a ginkgo-style charm that is elegant, earthy, and softly bohemian. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-turquoise-feather.jpg',
            },
            {
                id: 'item28',
                name: 'Brown Stone Vibes Bracelet',
                description: 'Earthy-toned, round and disc-shaped beads in shades of brown, black, and reddish stone, accented with warm copper spacers displaying a rustic, natural look. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-brown-vibes.jpg',
            },
            {
                id: 'item29',
                name: 'Green Nature Vibes Bracelet',
                description: 'A multi-strand bracelet that features earthy green and amber-toned beads, accented with decorative bronze spacers, and includes one macram√©-style woven strand in tan cord with a natural and bohemian vibe. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-green-vibes.jpg',
            },
            {
                id: 'item30',
                name: 'Blue Bracelet with Hand Wings',
                description: 'The bracelet features deep navy-blue round beads paired with silver spacers, and it includes two dangling silver charms‚Äîa Hamsa hand and small leaves displaying a simple, symbolic, and elegant look. Handcrafted by Fiddle & Thread KSQ.',
                startingBid: 12,
                imageUrl: 'Images/jewelry-blue-wings.jpg',
            },
            {
                id: 'item31',
                name: 'Holiday Pinecone Wreath',
                description: 'Handmade Holiday Pinecone 24" Wreath with wreath storage container. By Amy Murray',
                startingBid: 20,
                imageUrl: 'Images/wreath.jpg',
            },
            {
                id: 'item32',
                name: 'Crocheted Yarn Pumpkins',
                description: 'Handmade Crocheted Yarn Pumpkins. Made by Mandy Antczak (Josie and Nolan\'s Grandma)',
                startingBid: 10,
                imageUrl: 'Images/pumpkins.jpg',
            },
            {
                id: 'item33',
                name: 'rEvolve Gift Basket',
                description: '1. Daisy rug\n2. Twist perfume (Mountain)\n3. Hand forged brass earrings made by local artist, Callisa Lawn\n4. Cat Kitchen print by local artist, Sid Worsham\n5. Large pink lidded ceramic vessel by local potter, Katlyn Swords\n6. Handmade light pink scarf\n7. Croissant air freshener\n8. Cute pair of socks\n9. Pair of strawberry hair clips',
                startingBid: 10,
                imageUrl: 'Images/gift-basket.jpg',
            },
            {
                id: 'item34',
                name: 'LSH Tote Bag',
                description: 'LSH tote bag (2 autographed by Mr. Gibbs available)',
                startingBid: 10,
                imageUrl: 'Images/lsh-tote.jpg',
                quantity: 4,
            },
            {
                id: 'item35',
                name: 'Tabletop Roleplaying Game Session',
                description: 'Introduction to Tabletop Roleplaying Games ‚Äî Private Session. Discover the fun, creativity, and collaboration of tabletop roleplaying games in this family-friendly "Introduction to TTRPGs" experience! Perfect for beginners of all ages (readers who can do basic arithmetic), this 3‚Äì4 hour session teaches what tabletop roleplaying games are, how they connect to classics like Dungeons & Dragons, and how to jump right into playing a simple, rules-light adventure. Your host is an experienced Game Master who provides everything needed for the session‚Äîjust bring your imagination and enthusiasm! What\'s included: Overview of TTRPGs, Guided character creation, Clear rules explanation, A fun beginner-friendly adventure, All materials provided. Session Details: Length 3‚Äì4 hours, Suitable for families/kids/adults or solo, No experience required. Scheduling: Weeknights 7pm‚Äì11pm start, Sundays 10am‚Äì5pm start. Unavailable: Nov 24‚Äì30 and Dec 22‚ÄìJan 1. A $20/person value for a multi-hour private experience!',
                startingBid: 40,
                imageUrl: 'Images/rpg.jpg',
                quantity: 3,
            },
            {
                id: 'item36',
                name: 'Stained Glass Axolotl',
                description: 'Handmade stained glass axolotl by local artist. www.resin8light.com',
                startingBid: 30,
                imageUrl: 'Images/axolotl.jpg',
            },
            {
                id: 'item37',
                name: 'Coffee Lovers Bundle',
                description: 'Coffee Lovers\' Bundle from Cooperative Coffee includes: a tasting box with four coffees (roughly $80 value, before tax), two colorful diner mugs ($24 value) and two \'tickets\' to a coffee cupping. https://cooperativecoffeeroasters.com/',
                startingBid: 80,
                imageUrl: 'Images/coffee-bundle.jpg',
                quantity: 2,
            },
            {
                id: 'item38',
                name: 'Hand Crafted Gift Basket',
                description: 'Handcrafted gift basket - made with locally sourced materials and full of sweet holiday treats from Appalachian Craft Baskets. https://appalachiancraftbaskets.com',
                startingBid: 20,
                imageUrl: 'Images/appgift.jpg',
            },
            {
                id: 'item39',
                name: 'Three Christmas Ornaments',
                description: 'Set of three handmade felted Christmas ornaments.',
                startingBid: 30,
                imageUrl: 'Images/Felt Ornament Balls.jpeg',
            },
            {
                id: 'item40',
                name: 'Xmas Flamingo Ornament',
                description: 'Handmade felted Christmas flamingo ornament.',
                startingBid: 10,
                imageUrl: 'Images/Felt Flamingo.jpeg',
            },
            {
                id: 'item41',
                name: 'Soccer Ball Ornament',
                description: 'Handmade felted soccer ball ornament.',
                startingBid: 8,
                imageUrl: 'Images/Felt Soccer Ball.jpeg',
            },
            {
                id: 'item42',
                name: 'Professor Bunny Ornament',
                description: 'Handmade felted professor bunny ornament.',
                startingBid: 10,
                imageUrl: 'Images/Felt Professor Bunny.jpeg',
            },
            {
                id: 'item43',
                name: 'Avocado Ornament',
                description: 'Handmade felted avocado ornament.',
                startingBid: 10,
                imageUrl: 'Images/Felt Avocado.jpeg',
            },
            {
                id: 'item44',
                name: 'Bad Bunny Ornament',
                description: 'Handmade felted Bad Bunny ornament.',
                startingBid: 8,
                imageUrl: 'Images/Felt Bad Bunny.jpeg',
            },
            {
                id: 'item45',
                name: 'Mini Christmas Photo Session',
                description: 'Professional mini Christmas photo session with Ashlyn Davis Photography.',
                startingBid: 75,
                imageUrl: 'Images/Mini Christmas Photo Session.jpeg',
            },
            {
                id: 'item46',
                name: 'Cabo Card Game Deck',
                description: 'Your new favorite card game! Cabo is fast, fun, and easy to learn ‚Äì perfect for family game night, in the stands at soccer practice, or killing time in homeroom. Simple, fast-paced, and actually fun ‚Äì for parents, kids, and grandparents alike. Quick and portable, Cabo gives you a way to connect in real time, anywhere you go.\n\nEach Player starts with four face-down cards and only partial knowledge of what they\'re holding. Swap, Spy, Peek, and draw your way to the lowest score. Call "Cabo" when you think you\'ve won.\n\n‚Ä¢ 2-5 Players (more with multiple decks)\n‚Ä¢ Ages 8+\n‚Ä¢ Learn in under 5 minutes\n‚Ä¢ Full game takes 30 minutes\n‚Ä¢ Rounds are as quick as 5 minutes\n‚Ä¢ Great for travel, game night, classrooms, and more.\n‚Ä¢ Made in Asheville\n‚Ä¢ Original artwork by Raleigh artist Adam Peele\n‚Ä¢ Printed in USA\n\nCompany: Shareful Games, LLC\nWebsite: www.cabogame.com',
                startingBid: 2,
                imageUrl: 'Images/cabo.jpg',
                quantity: 6,
            },
        ];

        // Store current bids and selected item
        let currentBids = {};
        let selectedItem = null;
        let pendingBidData = null;
        let auctionIsOpen = true;
        let bidSubmissions = [];

        // Initialize the page
        function init() {
            checkAuctionStatus();
            renderItems();         // render once
            fetchCurrentBids();    // load initial bids
            // Update bids every 15 seconds
            setInterval(fetchCurrentBids, 15000);
            // Check auction status every minute
            setInterval(checkAuctionStatus, 60000);
        }

        // Check if auction is still open
        function checkAuctionStatus() {
            const now = new Date();
            auctionIsOpen = now < AUCTION_END_TIME;
            
            const statusElement = document.getElementById('auctionStatus');
            if (!auctionIsOpen) {
                statusElement.textContent = 'Auction is CLOSED';
                statusElement.classList.add('closed');
                // Disable all bid buttons
                document.querySelectorAll('.btn-bid').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'Auction Closed';
                });
            } else {
                const timeLeft = Math.floor((AUCTION_END_TIME - now) / 1000 / 60 / 60);
                if (timeLeft < 24) {
                    statusElement.textContent = `Auction closes in ${timeLeft} hours`;
                }
            }
        }

        // Get minimum bid increment based on current bid
        function getMinimumBidIncrement(currentBid) {
            if (currentBid < 100) return 5;
            if (currentBid < 500) return 10;
            if (currentBid < 1000) return 25;
            if (currentBid < 5000) return 50;
            return 100;
        }

        // Helper function to safely extract bid amount from bid data
        function getBidAmount(bidData, defaultValue) {
            if (!bidData) return defaultValue;
            if (typeof bidData === 'object' && bidData.bidAmount !== undefined) {
                return Number(bidData.bidAmount);
            }
            if (typeof bidData === 'number') {
                return bidData;
            }
            return defaultValue;
        }

        // Get phone identifier for display (returns object with text or null)
        function getPhoneIdentifier(bidData) {
            console.log('getPhoneIdentifier called with:', bidData);
            if (!bidData || typeof bidData !== 'object') {
                console.log('No bidData or not an object');
                return null;
            }
            if (!bidData.phone) {
                console.log('No phone field in bidData');
                return null;
            }
            const phone = String(bidData.phone);
            console.log('Phone number:', phone);
            const digitsOnly = phone.replace(/\D/g, '');
            if (digitsOnly.length >= 4) {
                const last4 = digitsOnly.slice(-4);
                const result = { text: `Highest Bidder: ${last4}` };
                console.log('Returning phone identifier:', result);
                return result;
            }
            console.log('Not enough digits in phone');
            return null;
        }

        // Extract last 4 digits from phone number
        function getPhoneLast4(phone) {
            if (!phone) return null;
            const digitsOnly = String(phone).replace(/\D/g, '');
            return digitsOnly.length >= 4 ? digitsOnly.slice(-4) : null;
        }

        // Get top N bids for multi-quantity items (returns array)
        function getTopBids(bidData, quantity) {
            console.log('getTopBids called:', { bidData, quantity, isArray: Array.isArray(bidData) });
            
            // If bidData is an array, it's already formatted for multi-quantity
            if (Array.isArray(bidData)) {
                const result = bidData.slice(0, quantity).map(bid => ({
                    amount: Number(bid.bidAmount || bid.amount || 0),
                    phone: getPhoneLast4(bid.phone),
                    fullName: bid.fullName
                }));
                console.log('Returning array of bids:', result);
                return result;
            }
            // If it's a single bid object, wrap it in an array
            if (bidData && typeof bidData === 'object' && bidData.bidAmount) {
                const result = [{
                    amount: Number(bidData.bidAmount),
                    phone: getPhoneLast4(bidData.phone),
                    fullName: bidData.fullName
                }];
                console.log('Wrapping single bid:', result);
                return result;
            }
            console.log('No valid bid data, returning empty array');
            return [];
        }

        // Render top bidders dropdown for multi-quantity items
        function renderTopBidders(item, bids) {
            const quantity = item.quantity || 1;
            const hasBids = bids && bids.length > 0;
            const bidCount = hasBids ? bids.length : 0;
            
            console.log(`renderTopBidders for ${item.name}:`, { quantity, bidCount, bids });
            
            let bidsHtml = '';
            if (hasBids) {
                bidsHtml = bids.map((bid, index) => `
                    <div class="bidder-row">
                        <span class="bidder-rank">#${index + 1}</span>
                        <span class="bidder-amount">$${bid.amount}</span>
                        <span class="bidder-phone">${bid.phone ? `ends in ${bid.phone}` : 'N/A'}</span>
                    </div>
                `).join('');
            } else {
                bidsHtml = '<div class="no-bids-message">No bids yet - be the first!</div>';
            }

            return `
                <div class="top-bidders-container">
                    <div class="top-bidders-header" onclick="toggleTopBidders('${item.id}')">
                        <div class="top-bidders-title">
                            Top Bidders<span class="quantity-badge">${bidCount} of ${quantity}</span>
                        </div>
                        <div class="dropdown-arrow expanded" id="arrow-${item.id}">‚ñº</div>
                    </div>
                    <div class="top-bidders-list expanded" id="bidders-${item.id}">
                        ${bidsHtml}
                    </div>
                </div>
            `;
        }

        // Toggle top bidders dropdown
        function toggleTopBidders(itemId) {
            const list = document.getElementById(`bidders-${itemId}`);
            const arrow = document.getElementById(`arrow-${itemId}`);
            
            if (list && arrow) {
                list.classList.toggle('expanded');
                arrow.classList.toggle('expanded');
            }
        }

        // Generate unique bid ID
        function generateBidId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Check rate limiting (client-side)
        function checkRateLimit(email) {
            const now = Date.now();
            const fiveMinutesAgo = now - (5 * 60 * 1000);
            
            // Clean old submissions
            bidSubmissions = bidSubmissions.filter(sub => sub.time > fiveMinutesAgo);
            
            // Count submissions from this email
            const recentSubmissions = bidSubmissions.filter(sub => sub.email === email);
            
            if (recentSubmissions.length >= 5) {
                return false; // Rate limit exceeded
            }
            
            // Add this submission
            bidSubmissions.push({ email, time: now });
            return true;
        }

        // Render all items (run once)
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            grid.innerHTML = items.map(item => {
                const bidData = currentBids[item.name];
                const quantity = item.quantity || 1;
                const isMultiQuantity = quantity > 1;
                
                let currentBid, phoneHtml;
                
                if (isMultiQuantity) {
                    // For multi-quantity items, show top N bids
                    const topBids = getTopBids(bidData, quantity);
                    // Current bid is the lowest winning bid (or starting bid if no bids)
                    currentBid = topBids.length > 0 ? topBids[topBids.length - 1].amount : item.startingBid;
                    phoneHtml = renderTopBidders(item, topBids);
                } else {
                    // For single-quantity items, use existing logic
                    currentBid = getBidAmount(bidData, item.startingBid);
                    const phoneData = getPhoneIdentifier(bidData);
                    phoneHtml = phoneData ? `<div class="bidder-identifier">${phoneData.text}</div>` : '';
                }
                
                const increment = getMinimumBidIncrement(currentBid);
                const minNextBid = currentBid + increment;
                
                console.log(`Rendering ${item.name}: quantity=${quantity}, isMulti=${isMultiQuantity}`);
                
                return `
                <div class="item-card ${!auctionIsOpen ? 'disabled' : ''}">
                    <img src="${item.imageUrl}" alt="${item.name}" class="item-image">
                    <div class="item-content">
                        <div class="item-title">${item.name}</div>
                        ${isMultiQuantity ? `<div class="quantity-indicator">Quantity: ${quantity} available</div>` : ''}
                        <div class="item-price">
                            <span class="price-label">${isMultiQuantity ? 'Lowest Winning Bid:' : 'Current Bid:'} </span>
                            <span id="price-${item.id}">$${currentBid}</span>
                        </div>
                        <div class="bid-increment" id="minbid-${item.id}">Next minimum bid: $${minNextBid}</div>
                        <div class="item-buttons">
                            <button class="btn btn-details" onclick="showDetails('${item.id}')">Details</button>
                            <button class="btn btn-bid" onclick="showBidForm('${item.id}')" 
                                ${!auctionIsOpen ? 'disabled' : ''}>
                                ${auctionIsOpen ? 'Bid Now' : 'Auction Closed'}
                            </button>
                        </div>
                        <div id="phone-${item.id}">${phoneHtml}</div>
                    </div>
                </div>
            `}).join('');
        }

        // Update only the bids that changed (no full re-render)
        function updateBids(data) {
            // If the grid is empty for some reason, re-render
            if (!document.getElementById('itemsGrid').children.length) {
                renderItems();
            }

            items.forEach(item => {
                const bidData = data[item.name];
                const quantity = item.quantity || 1;
                const isMultiQuantity = quantity > 1;
                
                let newBid;
                if (isMultiQuantity) {
                    const topBids = getTopBids(bidData, quantity);
                    newBid = topBids.length > 0 ? topBids[topBids.length - 1].amount : item.startingBid;
                } else {
                    newBid = getBidAmount(bidData, item.startingBid);
                }
                
                const priceEl = document.getElementById(`price-${item.id}`);
                const minEl = document.getElementById(`minbid-${item.id}`);
                const phoneEl = document.getElementById(`phone-${item.id}`);

                // Update price text only when changed
                if (priceEl) {
                    const oldText = priceEl.textContent;
                    const newText = `$${newBid}`;
                    if (oldText !== newText) {
                        priceEl.textContent = newText;
                        // small visual highlight for change
                        priceEl.classList.add('price-updated');
                        setTimeout(() => priceEl.classList.remove('price-updated'), 700);
                    }
                }

                // Update minimum next bid text if it exists and changed
                if (minEl) {
                    const increment = getMinimumBidIncrement(newBid);
                    const minNext = newBid + increment;
                    const minText = `Next minimum bid: $${minNext}`;
                    if (minEl.textContent !== minText) {
                        minEl.textContent = minText;
                    }
                }

                // Update phone display area
                if (phoneEl) {
                    if (isMultiQuantity) {
                        // Handle multi-quantity items with top bidders dropdown
                        const topBids = getTopBids(bidData, quantity);
                        const hasTopBidders = phoneEl.querySelector('.top-bidders-container') !== null;
                        
                        if (topBids.length > 0 || bidData) {
                            const newHtml = renderTopBidders(item, topBids);
                            // Only update if content changed
                            if (!hasTopBidders || phoneEl.innerHTML !== newHtml) {
                                phoneEl.innerHTML = newHtml;
                                console.log(`üîÑ Updated top bidders for ${item.name}`);
                            }
                        }
                    } else {
                        // Handle single-quantity items with phone identifier
                        const phoneData = getPhoneIdentifier(bidData);
                        const currentHasPhone = phoneEl.querySelector('.bidder-identifier') !== null;
                        
                        console.log(`üì± Checking ${item.name}: bidData=`, bidData, 'phoneData=', phoneData, 'currentHasPhone=', currentHasPhone);
                        
                        if (phoneData && !currentHasPhone) {
                            // Add phone identifier
                            const div = document.createElement('div');
                            div.className = 'bidder-identifier';
                            div.textContent = phoneData.text;
                            phoneEl.innerHTML = ''; // Clear safely
                            phoneEl.appendChild(div);
                            console.log(`‚úÖ Added phone identifier for ${item.name}`);
                        } else if (phoneData && currentHasPhone) {
                            // Update existing phone identifier using textContent
                            const existingDiv = phoneEl.querySelector('.bidder-identifier');
                            if (existingDiv && existingDiv.textContent !== phoneData.text) {
                                existingDiv.textContent = phoneData.text;
                                console.log(`üîÑ Updated phone identifier for ${item.name}`);
                            }
                        } else if (!phoneData && currentHasPhone && bidData) {
                            // ONLY remove if we have bidData but no phone (meaning server said no phone)
                            // Don't remove if bidData is undefined (server hasn't responded yet)
                            phoneEl.innerHTML = ''; // Clear safely
                            console.log(`‚ùå Removed phone identifier for ${item.name} (server has bid but no phone)`);
                        }
                        // If !phoneData && !bidData, do nothing (keep whatever is there from initial render)
                    }
                }
            });
        }

        // Fetch current bids from Google Apps Script
        async function fetchCurrentBids() {
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                document.getElementById('loadingIndicator').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL + '?action=getBids');
                const data = await response.json();
                
                // Debug logging
                console.log('üìä Bid data received:', data);
                console.log('üìä Number of items with bids:', Object.keys(data).length);
                
                // Keep a reference to prior bids if you want to compare or animate
                currentBids = data || {};
                // Update only what changed (no DOM wholesale replacement)
                updateBids(currentBids);
                document.getElementById('loadingIndicator').style.display = 'none';
            } catch (error) {
                console.error('Error fetching bids:', error);
                document.getElementById('loadingIndicator').textContent = 'Using starting bids';
                setTimeout(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }, 2000);
            }
        }

        // Show item details modal
        function showDetails(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = item.name;
            document.getElementById('modalDescription').textContent = item.description;
            const bidData = currentBids[item.name];
            const currentBid = getBidAmount(bidData, item.startingBid);
            document.getElementById('modalPrice').textContent = `$${currentBid}`;
            document.getElementById('detailsModal').style.display = 'block';
        }

        // Close details modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Show bid form modal
        function showBidForm(itemId) {
            if (!auctionIsOpen) {
                alert('Sorry, the auction has ended. No more bids can be placed.');
                return;
            }

            const item = items.find(i => i.id === itemId);
            if (!item) return;

            selectedItem = item;
            const bidData = currentBids[item.name];
            const currentBid = getBidAmount(bidData, item.startingBid);
            const increment = getMinimumBidIncrement(currentBid);
            const minBid = currentBid + increment;

            document.getElementById('bidItemName').textContent = `You are bidding on: ${item.name}`;
            document.getElementById('bidCurrentPrice').textContent = `$${currentBid}`;
            
            // Set minimum bid amount with increment
            const bidAmountField = document.getElementById('bidAmount');
            bidAmountField.min = minBid;
            bidAmountField.placeholder = `Minimum: $${minBid} (increment of $${increment})`;
            
            // Reset form
            document.getElementById('bidForm').reset();
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorBanner').style.display = 'none';
            document.getElementById('rateLimitWarning').style.display = 'none';
            clearErrors();
            
            document.getElementById('bidModal').style.display = 'block';
        }

        // Close bid modal
        function closeBidModal() {
            document.getElementById('bidModal').style.display = 'none';
            selectedItem = null;
        }

        // Clear form errors
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
        }

        // Validate email
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email) && email.length <= 100 && !email.includes('<') && !email.includes('>');
        }

        // Validate phone number (at least 10 digits)
        function isValidPhone(phone) {
            const digitsOnly = phone.replace(/\D/g, '');
            return digitsOnly.length >= 10 && digitsOnly.length <= 15;
        }

        // Validate name (2-50 chars, letters, spaces, hyphens, apostrophes)
        function isValidName(name) {
            const re = /^[a-zA-Z\s\-']+$/;
            return name.length >= 2 && name.length <= 50 && re.test(name);
        }

        // Sanitize input to prevent injection
        function sanitizeInput(input) {
            if (typeof input === 'string') {
                // Remove any characters that could start a formula in sheets
                return input.replace(/^[=+\-@]/g, '').trim();
            }
            return input;
        }

        // Handle form submission - show confirmation
        document.getElementById('bidForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            // Check honeypot field (bot protection)
            const honeypot = document.querySelector('input[name="website"]').value;
            if (honeypot) {
                // Bot detected - fake success
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(closeBidModal, 3000);
                return;
            }

            const fullName = sanitizeInput(document.getElementById('fullName').value.trim());
            const email = sanitizeInput(document.getElementById('email').value.trim().toLowerCase());
            const phone = sanitizeInput(document.getElementById('phone').value.trim());
            const bidAmount = parseInt(document.getElementById('bidAmount').value);

            let hasError = false;

            // Validate name
            if (!fullName || !isValidName(fullName)) {
                document.getElementById('nameError').textContent = 'Please enter a valid name (2-50 characters, letters only)';
                document.getElementById('nameError').style.display = 'block';
                document.getElementById('fullName').classList.add('error');
                hasError = true;
            }

            // Validate email
            if (!email || !isValidEmail(email)) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address';
                document.getElementById('emailError').style.display = 'block';
                document.getElementById('email').classList.add('error');
                hasError = true;
            }

            // Validate phone
            if (!phone || !isValidPhone(phone)) {
                document.getElementById('phoneError').textContent = 'Please enter a valid phone number (10-15 digits)';
                document.getElementById('phoneError').style.display = 'block';
                document.getElementById('phone').classList.add('error');
                hasError = true;
            }

            // Validate bid amount with increment and maximum bid difference
            const bidData = currentBids[selectedItem.name];
            const currentBid = getBidAmount(bidData, selectedItem.startingBid);
            const increment = getMinimumBidIncrement(currentBid);
            const minBid = currentBid + increment;
            const maxBid = currentBid + 100; // Maximum $100 above current bid

            if (!bidAmount || bidAmount < minBid || bidAmount > 1000000 || bidAmount > maxBid) {
                document.getElementById('bidError').style.display = 'block';
                if (bidAmount > 1000000) {
                    document.getElementById('bidError').textContent = 'Bid amount too high (max $1,000,000)';
                } else if (bidAmount > maxBid) {
                    document.getElementById('bidError').textContent = `Maximum bid cannot exceed $${maxBid} (current bid + $100)`;
                } else {
                    document.getElementById('bidError').textContent = `Minimum bid is $${minBid} (increment of $${increment})`;
                }
                document.getElementById('bidAmount').classList.add('error');
                hasError = true;
            }

            if (hasError) return;

            // Check rate limiting
            if (!checkRateLimit(email)) {
                document.getElementById('rateLimitWarning').style.display = 'block';
                return;
            }

            // Store bid data and show confirmation
            pendingBidData = {
                bidId: generateBidId(),
                fullName: fullName,
                email: email,
                phone: phone,
                bidAmount: bidAmount,
                itemName: selectedItem.name
            };

            showConfirmation();
        });

        // Show confirmation modal
        function showConfirmation() {
            document.getElementById('confirmItemName').textContent = pendingBidData.itemName;
            document.getElementById('confirmEmail').textContent = pendingBidData.email;
            document.getElementById('confirmBidAmount').textContent = `$${pendingBidData.bidAmount}`;
            document.getElementById('confirmModal').style.display = 'block';
        }

        // Edit bid - go back to form
        function editBid() {
            document.getElementById('confirmModal').style.display = 'none';
            // Form data is still there, user can edit
        }

        // Close confirmation modal
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingBidData = null;
        }

       async function confirmAndSubmitBid() {
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Submitting...';

    // Create a form and submit it (works better with Google Apps Script)
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = APPS_SCRIPT_URL;
    form.target = 'hidden_iframe';
    
    // Add all the fields
    const fields = {
        action: 'submitBid',
        bidId: pendingBidData.bidId,
        fullName: pendingBidData.fullName,
        email: pendingBidData.email,
        phone: pendingBidData.phone,
        bidAmount: pendingBidData.bidAmount.toString(),
        itemName: pendingBidData.itemName,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString()
    };
    
    for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    // Create hidden iframe if it doesn't exist
    let iframe = document.getElementById('hidden_iframe');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.name = 'hidden_iframe';
        iframe.id = 'hidden_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }
    
    // Submit the form
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // Handle success (we assume it worked since we can't read the response)
    setTimeout(() => {
        document.getElementById('confirmModal').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('bidForm').style.display = 'none';
        
        // Refresh bids
        fetchCurrentBids();
        
        setTimeout(() => {
            closeBidModal();
            document.getElementById('bidForm').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Bid';
        }, 3000);
    }, 1000);
    
    pendingBidData = null;
}

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                if (event.target.id === 'confirmModal') {
                    pendingBidData = null;
                }
            }
        }

        // Initialize when page loads
        window.onload = init;
    </script>
</body>
</html>
